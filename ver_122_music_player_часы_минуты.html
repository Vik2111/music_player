<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#667eea">
    <title>–ú–æ—è –∫–æ–ª–ª–µ–∫—Ü–∏—è</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            padding-top: max(20px, env(safe-area-inset-top));
            padding-bottom: 20px;
            padding-left: max(20px, env(safe-area-inset-left));
            padding-right: max(20px, env(safe-area-inset-right));
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: pan-y;
            font-size: var(--base-font-size, 16px);
        }

        :root {
            --base-font-size: 16px;
            --font-scale: 1;
        }

        body.font-small {
            --base-font-size: 14px;
            --font-scale: 0.875;
        }

        body.font-large {
            --base-font-size: 18px;
            --font-scale: 1.125;
        }

        body.font-xlarge {
            --base-font-size: 20px;
            --font-scale: 1.25;
        }

        body.font-xxlarge {
            --base-font-size: 24px;
            --font-scale: 1.5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .header h1 {
            font-size: calc(2.5em * var(--font-scale));
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .settings-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-btn:hover {
            background: white;
            color: #667eea;
            transform: rotate(90deg);
        }

        .search-container {
            background: white;
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .search-icon {
            font-size: 20px;
            color: #667eea;
        }

        .search-input {
            flex: 1;
            border: none;
            outline: none;
            font-size: calc(16px * var(--font-scale));
            color: #2d3748;
        }

        .search-input::placeholder {
            color: #a0aec0;
        }

        .search-icon {
            font-size: calc(20px * var(--font-scale));
            color: #667eea;
        }

        .tracks-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            margin-bottom: 100px;
        }

        .tracks-list {
            max-height: 70vh;
            overflow-y: auto;
        }

        .folder-header-item {
            padding: 15px 25px;
            background: #f7fafc;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .folder-header-item:active {
            background: #e2e8f0;
        }

        .folder-header-item:hover {
            background: #edf2f7;
        }

        .folder-header-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 600;
            color: #2d3748;
            font-size: calc(18px * var(--font-scale));
        }

        .folder-count-badge {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: calc(14px * var(--font-scale));
        }

        .folder-toggle {
            font-size: calc(20px * var(--font-scale));
            color: #667eea;
            transition: transform 0.3s;
        }

        .folder-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .track-item {
            padding: 18px 25px;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .track-item:active {
            background: #e2e8f0;
        }

        .track-item:hover {
            background: #f7fafc;
        }

        .track-item.selected {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border-left: 4px solid #667eea;
        }

        .track-item.playing {
            background: linear-gradient(135deg, #667eea30 0%, #764ba230 100%);
            border-left: 4px solid #667eea;
            font-weight: 600;
        }

        .track-info {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            flex: 1;
            min-width: 0;
        }

        .track-details {
            flex: 1;
            min-width: 0;
        }

        .track-name {
            color: #2d3748;
            font-size: calc(16px * var(--font-scale));
            word-wrap: break-word;
            overflow-wrap: break-word;
            margin-bottom: 6px;
        }

        .track-bottom-line {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 4px;
            gap: 10px;
        }

        .track-folder {
            font-size: calc(13px * var(--font-scale));
            color: #718096;
        }

        .track-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .play-count-badge {
            background: #667eea;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: calc(12px * var(--font-scale));
            font-weight: bold;
            white-space: nowrap;
        }

        .track-meta {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .track-duration {
            font-size: calc(11px * var(--font-scale));
            color: #a0aec0;
            font-weight: 500;
            white-space: nowrap;
        }

        .dragging {
            opacity: 0.5;
        }

        .drag-over {
            border-top: 3px solid #667eea;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .modal-header {
            padding: 25px 30px;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .modal-header h2 {
            font-size: calc(24px * var(--font-scale));
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: calc(28px * var(--font-scale));
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
        }

        .modal-section {
            margin-bottom: 30px;
        }

        .modal-section h3 {
            margin-bottom: 15px;
            color: #2d3748;
            font-size: calc(18px * var(--font-scale));
        }

        .sort-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .sort-option {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .sort-option:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .sort-option.active {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border-color: #667eea;
            font-weight: 600;
        }

        .sort-radio {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #cbd5e0;
            margin-right: 12px;
            position: relative;
            flex-shrink: 0;
        }

        .sort-option.active .sort-radio {
            border-color: #667eea;
        }

        .sort-option.active .sort-radio::after {
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            background: #667eea;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .sort-label {
            flex: 1;
            font-size: calc(15px * var(--font-scale));
            color: #2d3748;
        }

        .sort-description {
            font-size: calc(12px * var(--font-scale));
            color: #718096;
            margin-top: 4px;
        }

        .font-size-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
        }

        .font-size-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }

        .font-size-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            text-align: center;
        }

        .font-size-btn:hover {
            background: #f7fafc;
            border-color: #cbd5e0;
        }

        .font-size-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .font-size-preview {
            margin-top: 15px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            text-align: center;
        }

        .preview-text {
            color: #2d3748;
            margin-bottom: 8px;
        }

        .preview-small {
            font-size: calc(14px * var(--font-scale, 1));
        }

        .preview-normal {
            font-size: calc(16px * var(--font-scale, 1));
        }

        .preview-large {
            font-size: calc(18px * var(--font-scale, 1));
        }

        .playlist-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
        }

        .playlist-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .playlist-list {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .playlist-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f7fafc;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid #e2e8f0;
        }

        .playlist-item-name {
            font-weight: 600;
            color: #2d3748;
            font-size: calc(14px * var(--font-scale));
        }

        .playlist-item-count {
            font-size: calc(12px * var(--font-scale));
            color: #718096;
            margin-top: 2px;
        }

        .playlist-item-actions {
            display: flex;
            gap: 8px;
        }

        .playlist-btn-small {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: calc(12px * var(--font-scale));
            cursor: pointer;
            transition: all 0.3s;
        }

        .playlist-btn-load {
            background: #48bb78;
            color: white;
        }

        .playlist-btn-load:hover {
            background: #38a169;
        }

        .playlist-btn-delete {
            background: #fc8181;
            color: white;
        }

        .playlist-btn-delete:hover {
            background: #f56565;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: calc(15px * var(--font-scale));
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-bottom: 10px;
            -webkit-tap-highlight-color: transparent;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #fc8181;
            color: white;
        }

        .btn-danger:hover {
            background: #f56565;
        }

        .file-input {
            display: none;
        }

        .folders-list {
            margin-top: 20px;
        }

        .folder-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .track-settings-list {
            margin-top: 15px;
        }

        .track-settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid #e2e8f0;
        }

        .track-settings-item.selected {
            background: #edf2f7;
            border-color: #667eea;
        }

        .track-settings-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .track-settings-duration {
            font-size: 12px;
            color: #718096;
            min-width: 45px;
        }

        .track-settings-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .track-move-btn {
            background: #667eea;
            color: white;
            border: none;
            width: calc(32px * var(--font-scale));
            height: calc(32px * var(--font-scale));
            border-radius: 6px;
            cursor: pointer;
            font-size: calc(16px * var(--font-scale));
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .track-move-btn:hover {
            background: #5568d3;
        }

        .track-move-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }

        .bulk-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .bulk-btn {
            flex: 1;
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            font-size: calc(14px * var(--font-scale));
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .bulk-btn.enable {
            background: #48bb78;
            color: white;
        }

        .bulk-btn.enable:hover {
            background: #38a169;
        }

        .bulk-btn.disable {
            background: #fc8181;
            color: white;
        }

        .bulk-btn.disable:hover {
            background: #f56565;
        }

        .track-toggle {
            width: 50px;
            height: 26px;
            background: #cbd5e0;
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }

        .track-toggle.active {
            background: #48bb78;
        }

        .track-toggle-slider {
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .track-toggle.active .track-toggle-slider {
            transform: translateX(24px);
        }

        .track-settings-name {
            flex: 1;
            font-size: 14px;
            color: #2d3748;
        }

        .folder-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .folder-name {
            font-weight: 600;
            color: #2d3748;
            font-size: calc(16px * var(--font-scale));
        }

        .folder-count {
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: calc(12px * var(--font-scale));
        }

        .folder-delete {
            background: #fc8181;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: calc(13px * var(--font-scale));
            transition: all 0.3s;
        }

        .folder-delete:hover {
            background: #f56565;
        }

        .player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #2d3748;
            color: white;
            padding: 20px;
            padding-bottom: max(20px, env(safe-area-inset-bottom));
            box-shadow: 0 -5px 30px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        .player-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .current-track {
            font-size: calc(18px * var(--font-scale));
            font-weight: 600;
        }

        .playlist-info {
            color: #a0aec0;
            font-size: calc(14px * var(--font-scale));
        }

        .player-controls {
            display: flex;
            gap: 10px;
        }

        .player-btn {
            padding: 10px 20px;
            background: #4a5568;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: calc(14px * var(--font-scale));
            transition: all 0.3s;
        }

        .player-btn:hover {
            background: #2d3748;
        }

        audio {
            width: 100%;
        }

        .empty-state {
            text-align: center;
            padding: 60px 30px;
            color: #718096;
        }

        .empty-state h2 {
            font-size: calc(24px * var(--font-scale));
            margin-bottom: 10px;
            color: #2d3748;
        }

        .empty-state p {
            font-size: calc(16px * var(--font-scale));
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-weight: 600;
            font-size: calc(16px * var(--font-scale));
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .modal-content {
                margin: 10px;
            }

            .player {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéµ –ú–æ—è –∫–æ–ª–ª–µ–∫—Ü–∏—è</h1>
            <button class="settings-btn" id="settingsBtn">‚öôÔ∏è</button>
        </div>

        <div class="search-container">
            <span class="search-icon">üîç</span>
            <input type="text" class="search-input" id="searchInput" placeholder="–ü–æ–∏—Å–∫ —Ç—Ä–µ–∫–æ–≤...">
            <button class="search-clear" id="searchClear">‚úï</button>
        </div>

        <div class="tracks-container">
            <div class="tracks-list" id="tracksList">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–µ–π</h2>
                <button class="modal-close" id="closeModal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="modal-section">
                    <h3>–ü–æ—Ä—è–¥–æ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç—Ä–µ–∫–æ–≤</h3>
                    <div class="sort-options">
                        <div class="sort-option" data-sort="custom">
                            <div class="sort-radio"></div>
                            <div>
                                <div class="sort-label">‚úã –ö–∞–∫ –∑–∞–¥–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º</div>
                                <div class="sort-description">–í–∞—à –ø–æ—Ä—è–¥–æ–∫ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ–º</div>
                            </div>
                        </div>
                        <div class="sort-option" data-sort="alphabet">
                            <div class="sort-radio"></div>
                            <div>
                                <div class="sort-label">üî§ –ü–æ –∞–ª—Ñ–∞–≤–∏—Ç—É</div>
                                <div class="sort-description">–û—Ç –ê –¥–æ –Ø</div>
                            </div>
                        </div>
                        <div class="sort-option" data-sort="popularity">
                            <div class="sort-radio"></div>
                            <div>
                                <div class="sort-label">‚≠ê –ü–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏</div>
                                <div class="sort-description">–°–Ω–∞—á–∞–ª–∞ —á–∞—Å—Ç–æ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–µ–º—ã–µ</div>
                            </div>
                        </div>
                        <div class="sort-option" data-sort="folders">
                            <div class="sort-radio"></div>
                            <div>
                                <div class="sort-label">üìÅ –ü–æ –ø–∞–ø–∫–∞–º</div>
                                <div class="sort-description">–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏</div>
                            </div>
                        </div>
                        <div class="sort-option" data-sort="single">
                            <div class="sort-radio"></div>
                            <div>
                                <div class="sort-label">üìú –û–¥–Ω–∏–º —Å–ø–∏—Å–∫–æ–º</div>
                                <div class="sort-description">–í—Å–µ —Ç—Ä–µ–∫–∏ –±–µ–∑ –ø–∞–ø–æ–∫</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-section">
                    <h3>‚ôø –†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞</h3>
                    <p style="color: #718096; margin-bottom: 10px;">–í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞</p>
                    <div class="font-size-controls">
                        <button class="font-size-btn" data-size="small">
                            <div style="font-size: 12px;">–ê</div>
                            <div style="font-size: 10px; margin-top: 4px;">–ú–µ–ª–∫–∏–π</div>
                        </button>
                        <button class="font-size-btn" data-size="normal">
                            <div style="font-size: 16px;">–ê</div>
                            <div style="font-size: 11px; margin-top: 4px;">–û–±—ã—á–Ω—ã–π</div>
                        </button>
                        <button class="font-size-btn" data-size="large">
                            <div style="font-size: 20px;">–ê</div>
                            <div style="font-size: 12px; margin-top: 4px;">–ö—Ä—É–ø–Ω—ã–π</div>
                        </button>
                        <button class="font-size-btn" data-size="xlarge">
                            <div style="font-size: 24px;">–ê</div>
                            <div style="font-size: 13px; margin-top: 4px;">–û—á–µ–Ω—å –∫—Ä—É–ø–Ω—ã–π</div>
                        </button>
                        <button class="font-size-btn" data-size="xxlarge">
                            <div style="font-size: 28px;">–ê</div>
                            <div style="font-size: 14px; margin-top: 4px;">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π</div>
                        </button>
                    </div>
                    <div class="font-size-preview">
                        <div class="preview-text preview-small">–ü—Ä–∏–º–µ—Ä –º–µ–ª–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞</div>
                        <div class="preview-text preview-normal">–ü—Ä–∏–º–µ—Ä –æ–±—ã—á–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞</div>
                        <div class="preview-text preview-large">–ü—Ä–∏–º–µ—Ä –∫—Ä—É–ø–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞</div>
                    </div>
                </div>

                <div class="modal-section">
                    <h3>–î–æ–±–∞–≤–∏—Ç—å –º—É–∑—ã–∫—É</h3>
                    <button class="btn btn-primary" id="addTracksBtn">+ –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–∫–∏</button>
                    <button class="btn btn-primary" id="addFolderBtn">+ –î–æ–±–∞–≤–∏—Ç—å –ø–∞–ø–∫—É</button>
                    <input type="file" id="tracksInput" class="file-input" accept="audio/*" multiple>
                    <input type="file" id="folderInput" class="file-input" webkitdirectory directory multiple>
                </div>

                <div class="modal-section">
                    <h3>–ü–∞–ø–∫–∏ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏</h3>
                    <div class="folders-list" id="foldersList">
                        <p style="color: #718096; text-align: center;">–ù–µ—Ç –ø–∞–ø–æ–∫</p>
                    </div>
                </div>

                <div class="modal-section" id="trackSettingsSection" style="display: none;">
                    <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫–∞–º–∏ –≤ –ø–∞–ø–∫–µ</h3>
                    <div class="bulk-actions">
                        <button class="bulk-btn enable" id="enableAllBtn">‚úì –í–∫–ª—é—á–∏—Ç—å –≤—Å–µ</button>
                        <button class="bulk-btn disable" id="disableAllBtn">‚úï –í—ã–∫–ª—é—á–∏—Ç—å –≤—Å–µ</button>
                    </div>
                    <p style="color: #718096; margin-bottom: 10px;">–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–µ–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
                    <div class="track-settings-list" id="trackSettingsList"></div>
                    <button class="btn btn-secondary" id="backToFolders" style="background: #718096;">‚Üê –ù–∞–∑–∞–¥ –∫ –ø–∞–ø–∫–∞–º</button>
                </div>

                <div class="modal-section">
                    <button class="btn btn-danger" id="clearAllBtn">üóë –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∫–æ–ª–ª–µ–∫—Ü–∏—é</button>
                </div>
            </div>
        </div>
    </div>

            <div class="player" id="player" style="display: none;">
        <div class="player-info">
            <div>
                <div class="current-track" id="currentTrack">–ù–µ –≤—ã–±—Ä–∞–Ω —Ç—Ä–µ–∫</div>
                <div class="playlist-info" id="playlistInfo"></div>
            </div>
            <div class="player-controls">
                <button class="player-btn" id="pauseBtn">‚è∏ –ü–∞—É–∑–∞</button>
                <button class="player-btn" id="stopBtn">üö™ –í—ã—Ö–æ–¥</button>
            </div>
        </div>
        <audio id="audioPlayer" controls></audio>
    </div>

    <script>
        class AudioDB {
            constructor() {
                this.dbName = 'MusicCollectionDB';
                this.version = 1;
                this.db = null;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);

                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve();
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('tracks')) {
                            db.createObjectStore('tracks', { keyPath: 'id' });
                        }
                        if (!db.objectStoreNames.contains('audioFiles')) {
                            db.createObjectStore('audioFiles', { keyPath: 'id' });
                        }
                    };
                });
            }

            async saveTracks(tracks) {
                const transaction = this.db.transaction(['tracks'], 'readwrite');
                const store = transaction.objectStore('tracks');
                
                await store.clear();
                
                for (const track of tracks) {
                    await store.put({
                        id: track.id,
                        name: track.name,
                        folder: track.folder,
                        playCount: track.playCount,
                        duration: track.duration,
                        hidden: track.hidden || false,
                        favorite: track.favorite || false
                    });
                }
            }

            async loadTracks() {
                const transaction = this.db.transaction(['tracks'], 'readonly');
                const store = transaction.objectStore('tracks');
                const request = store.getAll();

                return new Promise((resolve) => {
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => resolve([]);
                });
            }

            async saveAudioFile(id, blob) {
                const transaction = this.db.transaction(['audioFiles'], 'readwrite');
                const store = transaction.objectStore('audioFiles');
                await store.put({ id, blob });
            }

            async loadAudioFile(id) {
                const transaction = this.db.transaction(['audioFiles'], 'readonly');
                const store = transaction.objectStore('audioFiles');
                const request = store.get(id);

                return new Promise((resolve) => {
                    request.onsuccess = () => {
                        const result = request.result;
                        resolve(result ? result.blob : null);
                    };
                    request.onerror = () => resolve(null);
                });
            }

            async deleteAudioFile(id) {
                const transaction = this.db.transaction(['audioFiles'], 'readwrite');
                const store = transaction.objectStore('audioFiles');
                await store.delete(id);
            }

            async clearAll() {
                const transaction = this.db.transaction(['tracks', 'audioFiles'], 'readwrite');
                await transaction.objectStore('tracks').clear();
                await transaction.objectStore('audioFiles').clear();
            }
        }

        class MusicManager {
            constructor() {
                this.db = new AudioDB();
                this.tracks = [];
                this.selectedTracks = [];
                this.playlist = [];
                this.currentTrackIndex = 0;
                this.collapsedFolders = new Set();
                this.searchQuery = '';
                this.selectedSettingTrack = null;
                this.currentFolderName = null;
                this.sortMode = localStorage.getItem('sortMode') || 'folders';
                this.fontSize = localStorage.getItem('fontSize') || 'normal';
                this.init();
            }

            async init() {
                await this.db.init();
                await this.loadTracks();
                this.applyFontSize();
                this.renderTracks();
                this.setupEventListeners();
            }

            async loadTracks() {
                this.tracks = await this.db.loadTracks();
            }

            async saveTracks() {
                await this.db.saveTracks(this.tracks);
            }

            async saveAudioMetadata(trackId, duration) {
                const track = this.tracks.find(t => t.id === trackId);
                if (track) {
                    track.duration = duration;
                    await this.saveTracks();
                }
            }

            formatDuration(seconds) {
               if (!seconds || seconds === 0) return '00:00';
               const hours = Math.floor(seconds / 3600);
               const mins = Math.floor((seconds % 3600) / 60);
               return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
            }
             
            setupEventListeners() {
                document.getElementById('settingsBtn').addEventListener('click', () => {
                    this.openSettings();
                });

                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.searchQuery = e.target.value.toLowerCase();
                    const clearBtn = document.getElementById('searchClear');
                    if (this.searchQuery) {
                        clearBtn.classList.add('visible');
                    } else {
                        clearBtn.classList.remove('visible');
                    }
                    this.renderTracks();
                });

                document.getElementById('searchClear').addEventListener('click', () => {
                    document.getElementById('searchInput').value = '';
                    this.searchQuery = '';
                    document.getElementById('searchClear').classList.remove('visible');
                    this.renderTracks();
                });

                document.getElementById('closeModal').addEventListener('click', () => {
                    this.closeSettings();
                });

                document.getElementById('settingsModal').addEventListener('click', (e) => {
                    if (e.target.id === 'settingsModal') {
                        this.closeSettings();
                    }
                });

                document.getElementById('addTracksBtn').addEventListener('click', () => {
                    document.getElementById('tracksInput').click();
                });

                document.getElementById('addFolderBtn').addEventListener('click', () => {
                    document.getElementById('folderInput').click();
                });

                document.getElementById('tracksInput').addEventListener('change', (e) => {
                    this.handleFilesUpload(e.target.files, '–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ');
                    e.target.value = '';
                });

                document.getElementById('folderInput').addEventListener('change', (e) => {
                    this.handleFolderUpload(e.target.files);
                    e.target.value = '';
                });

                document.getElementById('clearAllBtn').addEventListener('click', () => {
                    this.clearAllTracks();
                });

                document.getElementById('backToFolders').addEventListener('click', () => {
                    document.getElementById('trackSettingsSection').style.display = 'none';
                    document.getElementById('foldersList').parentElement.style.display = 'block';
                    this.selectedSettingTrack = null;
                    this.currentFolderName = null;
                    this.renderFoldersList();
                });

                document.getElementById('enableAllBtn').addEventListener('click', () => {
                    this.toggleAllTracks(false);
                });

                document.getElementById('disableAllBtn').addEventListener('click', () => {
                    this.toggleAllTracks(true);
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
                document.querySelectorAll('.sort-option').forEach(option => {
                    option.addEventListener('click', () => {
                        const sortMode = option.dataset.sort;
                        this.setSortMode(sortMode);
                    });
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–∞–∑–º–µ—Ä–∞ —à—Ä–∏—Ñ—Ç–∞
                document.querySelectorAll('.font-size-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const size = btn.dataset.size;
                        this.setFontSize(size);
                    });
                });

                document.getElementById('pauseBtn').addEventListener('click', () => this.togglePause());
                document.getElementById('stopBtn').addEventListener('click', () => this.stopPlayback());

                const audioPlayer = document.getElementById('audioPlayer');
                audioPlayer.addEventListener('ended', () => this.stopPlayback());
            }

            openSettings() {
                document.getElementById('settingsModal').classList.add('active');
                this.updateSortUI();
                this.updateFontSizeUI();
                this.renderFoldersList();
            }

            setSortMode(mode) {
                this.sortMode = mode;
                localStorage.setItem('sortMode', mode);
                this.updateSortUI();
                this.renderTracks();
            }

            updateSortUI() {
                document.querySelectorAll('.sort-option').forEach(option => {
                    if (option.dataset.sort === this.sortMode) {
                        option.classList.add('active');
                    } else {
                        option.classList.remove('active');
                    }
                });
            }

            setFontSize(size) {
                this.fontSize = size;
                localStorage.setItem('fontSize', size);
                this.applyFontSize();
                this.updateFontSizeUI();
            }

            applyFontSize() {
                document.body.classList.remove('font-small', 'font-large', 'font-xlarge', 'font-xxlarge');
                
                if (this.fontSize !== 'normal') {
                    document.body.classList.add(`font-${this.fontSize}`);
                }
            }

            updateFontSizeUI() {
                document.querySelectorAll('.font-size-btn').forEach(btn => {
                    if (btn.dataset.size === this.fontSize) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            }

            closeSettings() {
                document.getElementById('settingsModal').classList.remove('active');
            }

            renderFoldersList() {
                const foldersList = document.getElementById('foldersList');
                
                if (this.tracks.length === 0) {
                    foldersList.innerHTML = '<p style="color: #718096; text-align: center;">–ù–µ—Ç –ø–∞–ø–æ–∫</p>';
                    return;
                }

                const folders = {};
                this.tracks.forEach(track => {
                    if (!folders[track.folder]) {
                        folders[track.folder] = 0;
                    }
                    folders[track.folder]++;
                });

                foldersList.innerHTML = Object.entries(folders).map(([folderName, count]) => `
                    <div class="folder-item">
                        <div class="folder-info">
                            <div class="folder-name">üìÅ ${folderName}</div>
                            <div class="folder-count">${count}</div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="folder-delete" data-folder="${folderName}" style="background: #667eea;">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                            <button class="folder-delete" data-folder="${folderName}">üóë –£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>
                `).join('');

                foldersList.querySelectorAll('.folder-delete').forEach(btn => {
                    const isSettings = btn.textContent.includes('–ù–∞—Å—Ç—Ä–æ–π–∫–∏');
                    btn.addEventListener('click', () => {
                        if (isSettings) {
                            this.showTrackSettings(btn.dataset.folder);
                        } else {
                            this.deleteFolder(btn.dataset.folder);
                        }
                    });
                });
            }

            showTrackSettings(folderName) {
                this.currentFolderName = folderName;
                this.selectedSettingTrack = null;
                
                document.getElementById('foldersList').parentElement.style.display = 'none';
                document.getElementById('trackSettingsSection').style.display = 'block';
                
                const folderTracks = this.tracks.filter(t => t.folder === folderName);
                const trackSettingsList = document.getElementById('trackSettingsList');
                
                trackSettingsList.innerHTML = folderTracks.map((track, index) => `
                    <div class="track-settings-item" data-id="${track.id}" data-index="${index}">
                        <div class="track-settings-left">
                            <div class="track-settings-duration">‚è± ${this.formatDuration(track.duration)}</div>
                            <div class="track-settings-name">${track.name}</div>
                        </div>
                        <div class="track-settings-controls">
                            <button class="track-move-btn move-up" data-id="${track.id}" ${index === 0 ? 'disabled' : ''}>‚Üë</button>
                            <button class="track-move-btn move-down" data-id="${track.id}" ${index === folderTracks.length - 1 ? 'disabled' : ''}>‚Üì</button>
                            <div class="track-toggle ${track.hidden ? '' : 'active'}" data-id="${track.id}">
                                <div class="track-toggle-slider"></div>
                            </div>
                        </div>
                    </div>
                `).join('');

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–æ–≤
                trackSettingsList.querySelectorAll('.track-settings-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∞—Ö
                        if (e.target.classList.contains('track-move-btn') || 
                            e.target.classList.contains('track-toggle') ||
                            e.target.classList.contains('track-toggle-slider')) {
                            return;
                        }
                        
                        trackSettingsList.querySelectorAll('.track-settings-item').forEach(i => {
                            i.classList.remove('selected');
                        });
                        item.classList.add('selected');
                        this.selectedSettingTrack = parseFloat(item.dataset.id);
                    });
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–π
                trackSettingsList.querySelectorAll('.track-toggle').forEach(toggle => {
                    toggle.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const trackId = parseFloat(toggle.dataset.id);
                        const track = this.tracks.find(t => t.id === trackId);
                        if (track) {
                            track.hidden = !track.hidden;
                            toggle.classList.toggle('active');
                            this.saveTracks();
                            this.renderTracks();
                        }
                    });
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
                trackSettingsList.querySelectorAll('.move-up').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const trackId = parseFloat(btn.dataset.id);
                        this.moveTrackInFolder(trackId, -1);
                    });
                });

                trackSettingsList.querySelectorAll('.move-down').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const trackId = parseFloat(btn.dataset.id);
                        this.moveTrackInFolder(trackId, 1);
                    });
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è —Å—Ç—Ä–µ–ª–æ–∫
                document.addEventListener('keydown', this.handleKeyPress.bind(this));
            }

            handleKeyPress(e) {
                if (!this.selectedSettingTrack || !this.currentFolderName) return;
                
                if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    this.moveTrackInFolder(this.selectedSettingTrack, -1);
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    this.moveTrackInFolder(this.selectedSettingTrack, 1);
                }
            }

            moveTrackInFolder(trackId, direction) {
                const folderTracks = this.tracks.filter(t => t.folder === this.currentFolderName);
                const currentIndex = folderTracks.findIndex(t => t.id === trackId);
                
                if (currentIndex === -1) return;
                
                const newIndex = currentIndex + direction;
                if (newIndex < 0 || newIndex >= folderTracks.length) return;
                
                // –ù–∞—Ö–æ–¥–∏–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
                const globalCurrentIndex = this.tracks.findIndex(t => t.id === trackId);
                const targetTrack = folderTracks[newIndex];
                const globalTargetIndex = this.tracks.findIndex(t => t.id === targetTrack.id);
                
                // –ú–µ–Ω—è–µ–º –º–µ—Å—Ç–∞–º–∏
                [this.tracks[globalCurrentIndex], this.tracks[globalTargetIndex]] = 
                [this.tracks[globalTargetIndex], this.tracks[globalCurrentIndex]];
                
                this.saveTracks();
                this.renderTracks();
                this.showTrackSettings(this.currentFolderName);
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                setTimeout(() => {
                    const items = document.querySelectorAll('.track-settings-item');
                    items.forEach(item => {
                        if (parseFloat(item.dataset.id) === trackId) {
                            item.classList.add('selected');
                            item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    });
                }, 50);
            }

            toggleAllTracks(hide) {
                if (!this.currentFolderName) return;
                
                this.tracks.forEach(track => {
                    if (track.folder === this.currentFolderName) {
                        track.hidden = hide;
                    }
                });
                
                this.saveTracks();
                this.renderTracks();
                this.showTrackSettings(this.currentFolderName);
            }

            async handleFilesUpload(files, folderName) {
                const tracksList = document.getElementById('tracksList');
                tracksList.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤...</div>';

                for (const file of Array.from(files)) {
                    if (file.type.startsWith('audio/')) {
                        const trackId = Date.now() + Math.random();
                        
                        // –ü–æ–ª—É—á–∞–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
                        const duration = await this.getAudioDuration(file);
                        
                        const track = {
                            id: trackId,
                            name: file.name.replace(/\.[^/.]+$/, ''),
                            folder: folderName,
                            playCount: 0,
                            duration: duration,
                            hidden: false,
                            favorite: false
                        };
                        this.tracks.push(track);
                        await this.db.saveAudioFile(trackId, file);
                    }
                }

                await this.saveTracks();
                this.renderTracks();
                this.renderFoldersList();
            }

            async handleFolderUpload(files) {
                const tracksList = document.getElementById('tracksList');
                tracksList.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞–ø–∫–∏...</div>';

                const folderMap = {};
                
                Array.from(files).forEach(file => {
                    if (file.type.startsWith('audio/')) {
                        const pathParts = file.webkitRelativePath.split('/');
                        const folderName = pathParts.length > 1 ? pathParts[0] : '–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ';
                        
                        if (!folderMap[folderName]) {
                            folderMap[folderName] = [];
                        }
                        
                        folderMap[folderName].push(file);
                    }
                });

                for (const [folderName, files] of Object.entries(folderMap)) {
                    for (const file of files) {
                        const trackId = Date.now() + Math.random();
                        
                        console.log(`Processing file from folder: ${file.name}`);
                        
                        // –ü–æ–ª—É—á–∞–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å –æ–∂–∏–¥–∞–Ω–∏–µ–º
                        let duration = 0;
                        try {
                            duration = await this.getAudioDuration(file);
                            console.log(`Got duration for ${file.name}: ${duration}`);
                        } catch (error) {
                            console.error(`Error getting duration for ${file.name}:`, error);
                        }
                        
                        const track = {
                            id: trackId,
                            name: file.name.replace(/\.[^/.]+$/, ''),
                            folder: folderName,
                            playCount: 0,
                            duration: duration,
                            hidden: false,
                            favorite: false
                        };
                        this.tracks.push(track);
                        await this.db.saveAudioFile(trackId, file);
                        
                        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Ñ–∞–π–ª–∞–º–∏ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }

                await this.saveTracks();
                this.renderTracks();
                this.renderFoldersList();
            }

            getAudioDuration(file) {
                return new Promise((resolve) => {
                    const audio = new Audio();
                    const url = URL.createObjectURL(file);
                    
                    let resolved = false;
                    
                    const cleanup = (duration) => {
                        if (!resolved) {
                            resolved = true;
                            URL.revokeObjectURL(url);
                            audio.src = '';
                            resolve(duration);
                        }
                    };
                    
                    audio.addEventListener('loadedmetadata', () => {
                        const duration = audio.duration;
                        console.log(`Duration loaded for ${file.name}: ${duration}`);
                        cleanup(isFinite(duration) ? duration : 0);
                    });
                    
                    audio.addEventListener('durationchange', () => {
                        if (audio.duration && isFinite(audio.duration)) {
                            console.log(`Duration changed for ${file.name}: ${audio.duration}`);
                            cleanup(audio.duration);
                        }
                    });
                    
                    audio.addEventListener('error', (e) => {
                        console.error(`Error loading audio ${file.name}:`, e);
                        cleanup(0);
                    });
                    
                    // –¢–∞–π–º–∞—É—Ç –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∑—è—Ç—Å—è
                    setTimeout(() => {
                        if (!resolved) {
                            console.warn(`Timeout loading duration for ${file.name}`);
                            cleanup(0);
                        }
                    }, 5000);
                    
                    audio.preload = 'metadata';
                    audio.src = url;
                    audio.load();
                });
            }

            renderTracks() {
                const tracksList = document.getElementById('tracksList');
                
                if (this.tracks.length === 0) {
                    tracksList.innerHTML = `
                        <div class="empty-state">
                            <h2>–ö–æ–ª–ª–µ–∫—Ü–∏—è –ø—É—Å—Ç–∞</h2>
                            <p>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ ‚öôÔ∏è —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –º—É–∑—ã–∫—É</p>
                        </div>
                    `;
                    return;
                }

                // –§–∏–ª—å—Ç—Ä—É–µ–º —Å–∫—Ä—ã—Ç—ã–µ —Ç—Ä–µ–∫–∏
                let visibleTracks = this.tracks.filter(t => !t.hidden);
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–∏—Å–∫
                if (this.searchQuery) {
                    visibleTracks = visibleTracks.filter(track => 
                        track.name.toLowerCase().includes(this.searchQuery)
                    );
                }

                if (visibleTracks.length === 0) {
                    tracksList.innerHTML = `
                        <div class="empty-state">
                            <h2>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h2>
                            <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å</p>
                        </div>
                    `;
                    return;
                }

                let html = '';

                // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ"
                const favoriteTracks = visibleTracks.filter(t => t.favorite);
                if (favoriteTracks.length > 0) {
                    html += `
                        <div class="folder-header-item" data-folder="favorites">
                            <div class="folder-header-info">
                                <span>‚ù§Ô∏è –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</span>
                                <span class="folder-count-badge">${favoriteTracks.length}</span>
                            </div>
                            <div class="folder-toggle ${this.collapsedFolders.has('favorites') ? 'collapsed' : ''}">‚ñº</div>
                        </div>
                    `;

                    if (!this.collapsedFolders.has('favorites')) {
                        favoriteTracks.forEach(track => {
                            html += this.renderTrackItem(track);
                        });
                    }
                }

                // –†–µ–∂–∏–º "–ü–æ –ø–∞–ø–∫–∞–º" (—Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π –∏ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ–º)
                if (this.sortMode === 'folders') {
                    const folders = {};
                    visibleTracks.filter(t => !t.favorite).forEach(track => {
                        if (!folders[track.folder]) {
                            folders[track.folder] = [];
                        }
                        folders[track.folder].push(track);
                    });

                    Object.entries(folders).forEach(([folderName, tracks]) => {
                        const isCollapsed = this.collapsedFolders.has(folderName);
                        
                        html += `
                            <div class="folder-header-item" data-folder="${folderName}">
                                <div class="folder-header-info">
                                    <span>üìÅ ${folderName}</span>
                                    <span class="folder-count-badge">${tracks.length}</span>
                                </div>
                                <div class="folder-toggle ${isCollapsed ? 'collapsed' : ''}">‚ñº</div>
                            </div>
                        `;

                        if (!isCollapsed) {
                            tracks.forEach(track => {
                                html += this.renderTrackItem(track);
                            });
                        }
                    });
                }
                // –†–µ–∂–∏–º "–û–¥–Ω–∏–º —Å–ø–∏—Å–∫–æ–º"
                else if (this.sortMode === 'single') {
                    visibleTracks.filter(t => !t.favorite).forEach(track => {
                        html += this.renderTrackItem(track);
                    });
                }
                // –†–µ–∂–∏–º "–ü–æ –∞–ª—Ñ–∞–≤–∏—Ç—É"
                else if (this.sortMode === 'alphabet') {
                    const sortedTracks = [...visibleTracks.filter(t => !t.favorite)].sort((a, b) => 
                        a.name.localeCompare(b.name, 'ru')
                    );
                    
                    sortedTracks.forEach(track => {
                        html += this.renderTrackItem(track);
                    });
                }
                // –†–µ–∂–∏–º "–ü–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏"
                else if (this.sortMode === 'popularity') {
                    const sortedTracks = [...visibleTracks.filter(t => !t.favorite)].sort((a, b) => 
                        b.playCount - a.playCount
                    );
                    
                    sortedTracks.forEach(track => {
                        html += this.renderTrackItem(track);
                    });
                }
                // –†–µ–∂–∏–º "–ö–∞–∫ –∑–∞–¥–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"
                else if (this.sortMode === 'custom') {
                    visibleTracks.filter(t => !t.favorite).forEach(track => {
                        html += this.renderTrackItem(track);
                    });
                }

                tracksList.innerHTML = html;

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –ø–∞–ø–æ–∫
                tracksList.querySelectorAll('.folder-header-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const folderName = item.dataset.folder;
                        if (this.collapsedFolders.has(folderName)) {
                            this.collapsedFolders.delete(folderName);
                        } else {
                            this.collapsedFolders.add(folderName);
                        }
                        this.renderTracks();
                    });
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ç—Ä–µ–∫–æ–≤
                tracksList.querySelectorAll('.track-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('favorite-btn')) {
                            this.toggleTrackSelection(parseFloat(item.dataset.id));
                        }
                    });

                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
                    const favBtn = item.querySelector('.favorite-btn');
                    if (favBtn) {
                        favBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.toggleFavorite(parseFloat(item.dataset.id));
                        });
                    }

                    // Drag and drop —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ custom
                    if (this.sortMode === 'custom') {
                        item.addEventListener('dragstart', (e) => {
                            e.dataTransfer.effectAllowed = 'move';
                            e.dataTransfer.setData('text/html', item.dataset.id);
                            item.classList.add('dragging');
                        });

                        item.addEventListener('dragend', () => {
                            item.classList.remove('dragging');
                        });

                        item.addEventListener('dragover', (e) => {
                            e.preventDefault();
                            item.classList.add('drag-over');
                        });

                        item.addEventListener('dragleave', () => {
                            item.classList.remove('drag-over');
                        });

                        item.addEventListener('drop', (e) => {
                            e.preventDefault();
                            item.classList.remove('drag-over');
                            
                            const draggedId = parseFloat(e.dataTransfer.getData('text/html'));
                            const targetId = parseFloat(item.dataset.id);
                            
                            if (draggedId !== targetId) {
                                this.reorderTracks(draggedId, targetId);
                            }
                        });
                    }
                });
            }

            renderTrackItem(track) {
                const isSelected = this.selectedTracks.includes(track.id);
                const isPlaying = this.playlist.length > 0 && 
                                 this.playlist[this.currentTrackIndex] === track.id;
                const isFavorite = track.favorite || false;
                
                return `
                    <div class="track-item ${isSelected ? 'selected' : ''} ${isPlaying ? 'playing' : ''}" 
                         data-id="${track.id}"
                         ${this.sortMode === 'custom' ? 'draggable="true"' : ''}>
                        <div class="track-info">
                            <div class="track-details">
                                <div class="track-name">${track.name}</div>
                                <div class="track-bottom-line">
                                    <div class="track-folder">üìÅ ${track.folder}</div>
                                    <div class="track-meta">
                                        ${track.duration ? `<div class="track-duration">‚è± ${this.formatDuration(track.duration)}</div>` : '<div class="track-duration">‚è± 0:00:00</div>'}
                                        <div class="play-count-badge">${track.playCount}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button class="favorite-btn ${isFavorite ? 'active' : ''}" data-id="${track.id}">
                            ${isFavorite ? '‚ù§Ô∏è' : 'ü§ç'}
                        </button>
                    </div>
                `;
            }

            toggleFavorite(trackId) {
                const track = this.tracks.find(t => t.id === trackId);
                if (track) {
                    track.favorite = !track.favorite;
                    this.saveTracks();
                    this.renderTracks();
                }
            }

            togglePause() {
                const audioPlayer = document.getElementById('audioPlayer');
                const pauseBtn = document.getElementById('pauseBtn');
                
                if (audioPlayer.paused) {
                    audioPlayer.play();
                    pauseBtn.textContent = '‚è∏ –ü–∞—É–∑–∞';
                } else {
                    audioPlayer.pause();
                    pauseBtn.textContent = '‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
                }
            }

            toggleTrackSelection(trackId) {
                // –ï—Å–ª–∏ —É–∂–µ –∏–≥—Ä–∞–µ—Ç –¥—Ä—É–≥–æ–π —Ç—Ä–µ–∫, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –Ω–æ–≤—ã–π
                if (this.playlist.length > 0 && this.playlist[0] !== trackId) {
                    this.selectedTracks = [trackId];
                    this.playSelectedTracks();
                } else {
                    // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π —Ç—Ä–µ–∫ –∏–ª–∏ —Ç–æ—Ç –∂–µ —Å–∞–º—ã–π
                    this.selectedTracks = [trackId];
                    this.playSelectedTracks();
                }
                this.renderTracks();
            }

            playSelectedTracks() {
                if (this.selectedTracks.length === 0) return;
                
                // –°–æ–∑–¥–∞–µ–º –ø–ª–µ–π–ª–∏—Å—Ç —Ç–æ–ª—å–∫–æ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç—Ä–µ–∫–∞
                this.playlist = [this.selectedTracks[0]];
                this.currentTrackIndex = 0;
                
                this.playCurrentTrack();
            }

            reorderTracks(draggedId, targetId) {
                const draggedIndex = this.tracks.findIndex(t => t.id === draggedId);
                const targetIndex = this.tracks.findIndex(t => t.id === targetId);
                
                if (draggedIndex === -1 || targetIndex === -1) return;
                
                const draggedTrack = this.tracks[draggedIndex];
                this.tracks.splice(draggedIndex, 1);
                this.tracks.splice(targetIndex, 0, draggedTrack);
                
                this.saveTracks();
                this.renderTracks();
            }

            async playCurrentTrack() {
                if (this.playlist.length === 0) return;

                const trackId = this.playlist[this.currentTrackIndex];
                const track = this.tracks.find(t => t.id === trackId);
                
                if (!track) return;

                const audioBlob = await this.db.loadAudioFile(trackId);
                
                if (!audioBlob) {
                    alert('–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–∫–∏ –∑–∞–Ω–æ–≤–æ.');
                    return;
                }

                track.playCount++;
                await this.saveTracks();

                const audioPlayer = document.getElementById('audioPlayer');
                const player = document.getElementById('player');
                
                // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π URL –µ—Å–ª–∏ –µ—Å—Ç—å
                if (audioPlayer.src && audioPlayer.src.startsWith('blob:')) {
                    URL.revokeObjectURL(audioPlayer.src);
                }
                
                const url = URL.createObjectURL(audioBlob);
                audioPlayer.src = url;
                audioPlayer.load();
                
                try {
                    // –í–∞–∂–Ω–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ - play() –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    await audioPlayer.play();
                    
                    document.getElementById('currentTrack').textContent = track.name;
                    document.getElementById('playlistInfo').textContent = 
                        `–¢—Ä–µ–∫ ${this.currentTrackIndex + 1} –∏–∑ ${this.playlist.length} | üìÅ ${track.folder}`;
                    
                    player.style.display = 'block';

                    this.renderTracks();
                } catch (error) {
                    console.error('Playback error:', error);
                    // –ù–∞ Android –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è —è–≤–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
                    if (error.name === 'NotAllowedError') {
                        alert('–†–∞–∑—Ä–µ—à–∏—Ç–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
                    }
                }
            }

            playNext() {
                if (this.playlist.length === 0) return;
                
                if (this.currentTrackIndex < this.playlist.length - 1) {
                    this.currentTrackIndex++;
                    this.playCurrentTrack();
                } else {
                    // –ï—Å–ª–∏ –∫–æ–Ω–µ—Ü –ø–ª–µ–π–ª–∏—Å—Ç–∞, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
                    this.stopPlayback();
                }
            }

            playPrevious() {
                if (this.playlist.length === 0) return;
                
                if (this.currentTrackIndex > 0) {
                    this.currentTrackIndex--;
                    this.playCurrentTrack();
                }
            }

            stopPlayback() {
                const audioPlayer = document.getElementById('audioPlayer');
                const player = document.getElementById('player');
                
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                player.style.display = 'none';
                
                this.selectedTracks = [];
                this.playlist = [];
                this.currentTrackIndex = 0;
                
                this.renderTracks();
            }

            async deleteFolder(folderName) {
                const tracksCount = this.tracks.filter(t => t.folder === folderName).length;
                if (confirm(`–£–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É "${folderName}" –∏ –≤—Å–µ ${tracksCount} —Ç—Ä–µ–∫(–æ–≤)?`)) {
                    const tracksToDelete = this.tracks.filter(t => t.folder === folderName);
                    
                    for (const track of tracksToDelete) {
                        await this.db.deleteAudioFile(track.id);
                    }
                    
                    this.tracks = this.tracks.filter(t => t.folder !== folderName);
                    await this.saveTracks();
                    this.renderTracks();
                    this.renderFoldersList();
                }
            }

            async clearAllTracks() {
                if (confirm(`–£–¥–∞–ª–∏—Ç—å –≤—Å–µ ${this.tracks.length} —Ç—Ä–µ–∫(–æ–≤) –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏?`)) {
                    await this.db.clearAll();
                    this.tracks = [];
                    this.selectedTracks = [];
                    this.playlist = [];
                    this.renderTracks();
                    this.renderFoldersList();
                    this.closeSettings();
                }
            }
        }

        const app = new MusicManager();
    </script>
</body>
</html>